@model IEnumerable<TP2.Models.Product>
@{
    ViewData["Title"] = "Ma Liste de Souhaits";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    .heart-btn {
        border: none;
        background: transparent !important;
        cursor: pointer;
        font-size: 1.5rem;
        width: 30px;
        height: 30px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease;
    }

        .heart-btn:hover {
            transform: scale(1.2);
        }

    .empty-wishlist {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

        .empty-wishlist i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #dee2e6;
        }
</style>

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h1 class="display-4">
                Ma Liste de Souhaits
            </h1>
            <hr />
            <a href="@Url.Action("Index", "Product")" class="btn btn-outline-primary mb-3">
                <i class="fas fa-arrow-left"></i> Retour aux produits
            </a>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="empty-wishlist">
            <i class="fas fa-heart-broken"></i>
            <h3>Votre liste de souhaits est vide</h3>
            <p class="lead">Ajoutez des produits à votre liste de souhaits en cliquant sur le cœur</p>
            <a href="@Url.Action("Index", "Product")" class="btn btn-primary mt-3">
                <i class="fas fa-shopping-bag"></i> Parcourir les produits
            </a>
        </div>
    }
    else
    {
        <div class="card-group">
            @foreach (var product in Model)
            {
                var photoPath = "~/images/" + (product.Image ?? "noimage.jpg");

                <div class="card m-3" style="min-width: 18rem; max-width:30.5%;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <h5><b>Nom : </b> @product.Name</h5>
                                <h5><b>Prix : </b>@product.Price DT</h5>
                                <h5><b>Quantité : </b> @product.QteStock</h5>
                                <h5><b>Catégorie : </b>@product.Category?.CategoryName</h5>
                            </div>
                            <!-- Heart Button - Always active in wishlist view -->
                            <button class="btn btn-link p-0 heart-btn active"
                                    data-product-id="@product.ProductId"
                                    onclick="toggleWishlist(this)">
                                <i class="fas fa-heart text-danger" style="font-size: 1.5rem;"></i>
                            </button>
                        </div>
                    </div>

                    <img class="card-img-top imageThumbnail" src="@photoPath" asp-append-version="true"
                         style="height: 200px; object-fit: cover;" />

                    <div class="card-footer text-center">
                        <a asp-controller="Product" asp-action="Details" asp-route-id="@product.ProductId"
                           class="btn btn-primary m-1">View</a>
                        <a asp-controller="Panier" asp-action="AddProduct" class="btn btn-outline-secondary"
                           asp-route-id="@product.ProductId">Ajouter Au Panier</a>
                    </div>
                </div>
            }
        </div>

        <div class="mt-4 text-center">
            <p class="text-muted">
                <i class="fas fa-info-circle"></i>
                Vous avez @Model.Count() produit(s) dans votre liste de souhaits
            </p>
        </div>
    }
</div>

@section Scripts {
    <script>
        function toggleWishlist(button) {
            const productId = button.getAttribute('data-product-id');
            const heartIcon = button.querySelector('.fa-heart');
            const card = button.closest('.card');

            console.log('Removing from wishlist:', productId);

            // Send AJAX request to server
            fetch('/Wishlist/ToggleWishlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ productId: parseInt(productId) })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Remove the card from view with animation
                    card.style.opacity = '0';
                    card.style.transition = 'opacity 0.3s ease';

                    setTimeout(() => {
                        card.remove();

                        // Check if wishlist is now empty
                        const remainingCards = document.querySelectorAll('.card');
                        if (remainingCards.length === 0) {
                            // Reload page to show empty state
                            location.reload();
                        }
                    }, 300);
                } else {
                    alert('Erreur: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur de connexion. Veuillez réessayer.');
            });
        }
    </script>
}